{
    "contents" : "Gen_CO2.1=function(EB_G,CF,RowName,IO_Domestic,IO_Import,IO_whole,EC,Oil.Data,YR){\n# step 1 : Gross Calorific Value E balance => Net Calorific Value Energy E balance\n## Multiply Gross Calorific Value E balance (EB_G) with  conversion factor = [Net Calorific Value Energy Coversion Factor/Gross Calorific Value Energy Conversion Factor] (CF) for each fule/Electricity\n## Energy Balance is obtained from \"Yearbook of Energy Statistics\" (KEEI)\n## Conversion Factor is obatiend from 'Greenhouse Gas Inventrory and Research Center (2011). \"National Greenhouse Gas Inventory Report of Korea\"'\n## For Solvent/Asphalt/Parafiin-Wax, conversion factor is zero/For 'Other products' Conversion Factor is 0.95935 for no good reason.\n## For JA-1, JA-2, AVI-G, conversion factor for Jet is used\n## For Hydro, Nuclear, Electricity,Heat, Renewable, conversion factor is set as 1\n\n# Setting time\nYR_1=YR-1\n\n### step 1-1 : Loading data, conversion factor\n### step 1-2: convert into matrix and post muliply with diag CF (scale up columnes with CF)\nEB_N=(as.matrix(EB_G))%*%(diag(as.numeric(CF)))\n### step 1-3: add subsum and total columnes \nEB_N=data.frame(EB_N)\ncolnames(EB_N)=colnames(EB_G)\n\nAnthra_N=EB_N$Anthra_D+EB_N$Anthra_Im\nBit_N=EB_N$Bit_C+EB_N$Bit_S                        \nCoal_N=Anthra_N+Bit_N\nE_USE_N=rowSums(EB_N[,5:13])\nLPG_N=rowSums(EB_N[,14:15])\nNE_USE_N=rowSums(EB_N[,16:22])\nPetro_N=E_USE_N+LPG_N+NE_USE_N\nTotal_N= Coal_N+Petro_N+rowSums(EB_N[,23:29])\nEB_N_total=cbind(Coal_N,Anthra_N,EB_N[,1:2],Bit_N,EB_N[,3:4],Petro_N,E_USE_N,EB_N[,5:13],LPG_N,EB_N[,14:15],NE_USE_N,EB_N[,16:29],Total_N)\n \nAnthra_G=EB_G$Anthra_D+EB_G$Anthra_Im\nBit_G=EB_G$Bit_C+EB_G$Bit_S\nCoal_G=Anthra_G+Bit_G\nE_USE_G=rowSums(EB_G[,5:13])\nLPG_G=rowSums(EB_G[,14:15])\nNE_USE_G=rowSums(EB_G[,16:22])\nPetro_G=E_USE_G+LPG_G+NE_USE_G\nTotal_G= Coal_G+Petro_G+rowSums(EB_G[,23:29])\nEB_G_total=cbind(Coal_G,Anthra_G,EB_G[,1:2],Bit_G,EB_G[,3:4],Petro_G,E_USE_G,EB_G[,5:13],LPG_G,EB_G[,14:15],NE_USE_G,EB_G[,16:29],Total_G)\n\n### setp 1-4: add row names\n\nrow.names(EB_N_total)=c(\"\tDomestic\",\"Import\",\"PetroPro\",\"PetroIm\",\"Export\",\"IntBunk\",\"Stock_d\",\"f_Stock\t\",\"e_Stock\",\"Diff\",\"P_con\",\"Transform\",\"E_Gene\",\"Heating\",\"Gas_Manu\",\"OwnUse\",\"F_con\",\"Ind\",\"AFF\",\"Mine\",\"Manu\",\"Food\",\"Textile\",\"Wood\",\"PPP\",\"PetChem\",\"NonMetal\",\"IS\",\"Nonferr\",\"FabMetal\",\"Other_Manu\",\"Other_E\",\"\tConst\",\"Transport\",\"Rail_t\",\"Land_t\",\"Water_t\",\"Air_t\",\"Residential\",\"Commercial\",\"Public\")\t\n\nrow.names(EB_G_total)=c(\"\tDomestic\",\"Import\",\"PetroPro\",\"PetroIm\",\"Export\",\"IntBunk\",\"Stock_d\",\"f_Stock\t\",\"e_Stock\",\"Diff\",\"P_con\",\"Transform\",\"E_Gene\",\"Heating\",\"Gas_Manu\",\"OwnUse\",\"F_con\",\"Ind\",\"AFF\",\"Mine\",\"Manu\",\"Food\",\"Textile\",\"Wood\",\"PPP\",\"PetChem\",\"NonMetal\",\"IS\",\"Nonferr\",\"FabMetal\",\"Other_Manu\",\"Other_E\",\"\tConst\",\"Transport\",\"Rail_t\",\"Land_t\",\"Water_t\",\"Air_t\",\"Residential\",\"Commercial\",\"Public\")\t\n\nrow.names(EB_N)=row.names(EB_N_total)\nrow.names(EB_G)=row.names(EB_G_total)\n\n# step 2 : Net Calorific Value E balance => Total E demand by type of fuel/Electricity generation\n\n##step 2-1: Construction E_Demand by pick EB_N[\"P_con\",]\n\nE_Demand=EB_N[\"P_con\",]\n\n## step 2-2: Modification\n### (i) TownGas Primanry consumption is set as zero b/c Towngas is generated using LNG. \n###     But, burning Towngas is a primary source of GHG emission. \n###      So, we assign Primary Consumption of LNG to Towngas \n\nE_Demand$TownGas=E_Demand$LNG\n\n### (ii) Electricity generation : E demand for Hydro and nuclear is discounted with (860/2150) Why(?)\n\nE_Demand$Hydro=(860/2150)*E_Demand$Hydro\nE_Demand$Nuclear=(860/2150)*E_Demand$Nuclear\n\n### (iii) Electricity generation: E_demand for Electricity (Fossile fule) \n### a. P_con for Electricity doesn't exists, b/c Elec is generated from natural resources\n### b. F_con for Electricity contains E_Demand for Hydro and Nuclear. We want to get rid of them\n### c. F_con usually contains E_Demand for internatinal use. We take Export and IntBunk out to eleminate it\n### d. To get F_con, we sum P_con and Transformation. The Transformation has Electricity generation, District Heating, GAS manufacturing.\n###    If any of this item being negative, that means some of the Electricity generated has lost.\n###    But lost Electricity still generates GHG. We want to put those lost Elecricity back to Elec Demand\n###    If any of this item being positive, that means there is some byproduct with same amount of fuels are used. We ignore them\n### e. Transfomration also includes OwnUse and Loss, usually negative. They are not demanded but used and generate GHG. We want them back.\n### The formula for Electricity Demand become as follows\n### Elect Demand=F_con-Export-IntBunk-Stock_d-E_Gene*I(E_Gene<0)-Heating*I(Heating<0)-Gas_manu*I(Gas_manu<0)-Ownuse&Loss-E_Demand$Hydro-E_Demand$Nuclear\n \n \n\n#### step a. construct selection vector for relevent elements N. E_Demand\nN.E_Demand=c(\"F_con\",\"Export\",\"IntBunk\",\"Stock_d\",\"E_Gene\",\"Heating\",\"Gas_Manu\",\"OwnUse\")\n#### step b. obtain related values needed to construct formula\nElect_D=EB_N[N.E_Demand,]$Elect\n#### step c. obtain indicator function \ncondElect=c(rep(1,4),as.numeric(Elect_D[5:7]<0),1)\n#### step d. obtain operation vector\nfunElect=c(1, rep(-1,7))\n#### step e. obtain Elect Deamnd before hydro and nuclear adjustment\nS.Elect_D=sum(Elect_D*condElect*funElect)\n#### step f. substract Hydro and Nuclear\nS.Elect_D=S.Elect_D-E_Demand$Hydro-E_Demand$Nuclear\n#### step g. replace E_Demand$Elect\nE_Demand$Elect=S.Elect_D\n\n### (iv) Heating = P_con of Renewable (?)\n\nE_Demand$Heat=E_Demand$Renewable\n\n### (v) Renewable is set 0 (No GHG comes from Renewable)\n\nE_Demand$Renewable=0 \n\n\n##step 2-3: Add subsum\n\nAnthra_E=E_Demand$Anthra_D+E_Demand$Anthra_Im\nBit_E=E_Demand$Bit_C+E_Demand$Bit_S\nCoal_E=Anthra_E+Bit_E\nE_USE_E=rowSums(E_Demand[,5:13])\nLPG_E=rowSums(E_Demand[,14:15])\nNE_USE_E=rowSums(E_Demand[,16:22])\nPetro_E=E_USE_E+LPG_E+NE_USE_E\nTotal_E= Coal_E+Petro_E+rowSums(E_Demand[,23:29])\nE.Demand_total=cbind(Coal_E,Anthra_E,E_Demand[,1:2],Bit_E,E_Demand[,3:4],Petro_E,E_USE_E,E_Demand[,5:13],LPG_E,E_Demand[,14:15],NE_USE_E,E_Demand[,16:29],Total_E)\n\n## step 2-4: Odd Items. Yuntan/Crude Oil/Other Coal Product are in I-O, not in Energy Balance. \n## We assgin 'temporary energy demand' for these three items. \n## (Personally, I have doubts about this approach. \n##  a. Crude oil is mostly used in Oil production. Most of Energies are used  in Oil Product form. \n##  What we are missing here is the crude oil energy used in refineries. That wouldn't be much.\n##  b. Yuntan, is a form of Anthracite coal. Already the domestic use of Anthracite coal is included in Energy balance. Add yuntan could be double counting\n##  c. Other coal products. Very samll.  Can be ingonred.\n##  d. Overall. The error in 'guessing' the proper energy formula for these three item could be larger than the error in ignoring these three item.\n## Anyway, according to Kong, we assign energy demand for these three item as follows.\n\n### (i). Crude Oil\n\n#### a. Obtain the adjusted sum of [PetroProd + Diff*[PetroProd/Import]]*(1-I(Petroprod=0)) for coal products \n##### a.1. select appropriate statistics\nPetroitems=c(\"Gasoline\",\"Kerosene\",\"Diesel\",\t\"B.A\",\t\"B.B\",\t\"B.C\",\t\"JA.1\",\t\"JP.4\",\t\"AVI.G\",\t\"Propane\",\t\"Butane\",\t\"Naphta\",\t\"Solvent\",\t\"Asphalt\",\t\"Lubricant\",\t\"ParaWax\",\t\"PetroCoke\",\t\"OtherProd\")\nCrudeEitems=c(\"Import\",\"PetroPro\",\"Diff\")\nCrudeEdata=EB_N[CrudeEitems,Petroitems]\n\n#####  a.2. Excluded data with zero Import \n##### Since Crude Oil is 100% imported and converted into Petroleum Products, the energy demand in the form of crude oil is included in imports of each petroleum product. \n##### Itmes with zero Petroproduct are actually not used at all.\nS.CrudeEdata=CrudeEdata[,(CrudeEdata[\"PetroPro\",]!=0)]\n\n##### a.3. Obtain Crude Oil E demand included in each petroleum product.        \n##### P_Con= Domestic Product+Import+Export+IntBunk+Stock_d+Diff. We exclude Export and IntBunk (not in Korea), and Stock_d is added afterwords. \n##### The rest is Domestic Product, Import, Diff. But we don't have Domeistic Product.\n##### Import consists of Petro Product and Petro Import. \n##### We assume Petro Product E demand is E demand of Crude oil used to produce each Petro Product.\n##### And we assume that Stat.difference mainly conmes from Petro product and Petro Import. We also assume that the size of each fraction in Stat.difference is proportional to the E_demand  \nS.CrudeEdata=S.CrudeEdata[\"PetroPro\",]+S.CrudeEdata[\"Diff\",]*(S.CrudeEdata[\"PetroPro\",]/S.CrudeEdata[\"Import\",])\n\n##### a.4. take sum of the Crude Oil E demand included in each petroleum product.\nE.Demand_Crude_petroprod=sum(S.CrudeEdata)\n\n##### a.5. adjust for efficiency in burning Crude oil. Only 99% of Crude Oil input are actually burn. The rest is wasted. \n######  We adjsut E.Demand_Crude by diving it with 0.99. More Crude Oil is burned than the energy. (Emit CO2)\n\nE.Demand_Crude_petroprod=E.Demand_Crude_petroprod/0.99\n\n#### b. Add Stock change using YES 2010. Lower oil stock implies more oil than production is used to fulfil the demand. Higher oil stock implies some oil producec is not used. \n#### We adjuste E.Deamnd_Crude with Stock change.\n#### The 'stock chnage' here is the negative value of (2009 stock of Oil and Petro Product[7244 (1,000bbl)] -2008 stock of Oil and Petro Product[10723(1,000bbl)]  (2010 Yearbook of Energy Statistics, p.70)  \n#### The data of Oil and Petro Product stock is recorded in  Annual Energy Statistics Yearbook. \n#### Since the Product stock is recorded in barel (1000 bbl), we should devided E.Demand_Crude with 7.33 to convert bbl into toe. 1ton=1/7.33 bbl not 1toe. But Crude Oil 1 ton generates 1toe.       \n\nE.Demand_Crude_Stock_d=-1*(Oil.Data$Stocks[which(Oil.Data$year==YR)]-Oil.Data$Stocks[which(Oil.Data$year==YR_1)])/7.33\n\n#### c. Add domestic production\n#### We assume Domestic Production of crude oil = 321 (1000 bbl) (2010 Yearbook of Energy Statistics, p.70) \n#### Convert bbl into teo by dividing with 7.33\n\nE.Demand_Crude_domestic=Oil.Data$Domestic[which(Oil.Data$year==YR)]/7.33\n                                                                      \n\n#### d. Obtain Import.\n#### We exploit this identity P_con=Domestic Prod+Import+Stock_c+Diff.\n#### Wa assume that P_con=E.Demand_Crude_petroprod, Diff=0\n#### Then Import= P_con-Domestic Prod-Stock_c\n\nE.Demand_Crude_Im= E.Demand_Crude_petroprod-E.Demand_Crude_domestic-E.Demand_Crude_Stock_d\n\n#### e. obtain E.Demand for Crude Oil = Domestic Production + Import\nE.Demand_Crude=E.Demand_Crude_Im+E.Demand_Crude_domestic\n#### f. obtain E.Supply for Crude Oil = E.Demand-(stock change)\nE.Supply_Crude=E.Demand_Crude_petroprod-E.Demand_Crude_Stock_d\n\n### (ii). Coal Briquette (Yuntan) \n#### a. Residential Demand for Anthracite is used for the Demand for Yuntan.\nE.Demand_Coalbriquette = sum(EB_N[\"Residential\",1:2])\n#### b. Inflate  Domestic Demand with [1+(Total Final Demand of Yuntan|Import I-O)/(Total Final Demand of Yuntan|Domestic I-O)] to take Coal briguette import into account.\n####    The multiplication factor shows how much coal briqutte is imported when one unit of domesitc coal briqutte is used. \n##### load I-O information\n##### Find appropriate value to construct inflating number\nE.Demand_Coalbriquette =E.Demand_Coalbriquette*(1+(IO_Import[131,\"Total.demand\"]/IO_Domestic[131,\"Total.demand\"]))\n#E.Demand_Coalbriquette =E.Demand_Coalbriquette*(1+(13458/396625))\n\n### (iii) Other Coal Product (132 in 403)\n#### a. E.Demand.Other_c_dom is E.Demand of 'domestically produced' Other coal products. \n#### All imported Bit coal used in the form of other coal products are assumed to be used in domestic other coal product production. (Same as Yuntan)\n#### E.Demand.Other_c_dom is part of E.Demand of Bituminous Coal (Bit_N) not used in E_Gene\n#### E.Demand.Other_c_dom =(E.Demand Bit Coal not used in E_Gene)*(proportion of E.Demand of Bit Coal used in Other Coal Product form among E.Demand of Bit Coal unsed in E_Gene)\n#### (E.Demand of Bit Coal Other coal product/E.Demand of Bit Coal not used in E_Gene)\n#### =(Money spent in Bit Coal in Othe Coal Product production|(I-O)/[Money Spent in Bit Coal-Money Spend in Bit Coal used in E_Gene](I-O))|(Domestic+Import)\nE.Demand.Bit_residual=Bit_E-(-1)*min(c(EB_N_total[\"E_Gene\",\"Bit_N\"],0))\nE.Demand.Other_c_dom=E.Demand.Bit_residual*(IO_whole[31,\"Coke.and.other.coal.products\"]/(IO_whole[31,\"Total.demand\"]-IO_whole[31,\"Fire.power.generation\"]))\n#E.Demand.Other_c_dom=E.Demand.Bit_residual*(3650132/6032043)\n\n#### b. Inflate E.Demand.Other_c_dom with [1+(Total Final Demand of Other Coal Product|Import I-O)/(Total Final Demand of Other Coal Product|Domestic I-O)) to take Other Coal Products into account.\nE.Demand.Other_c=E.Demand.Other_c_dom*(1+(IO_Import[132,\"Total.demand\"]/IO_Domestic[132,\"Total.demand\"])) \n\n\n## step 2-5: Arrange to obtain Total E.Demand_total matching I-O (E.Demand_IO)\n## For Jet.Oil (135), We only use JA.1\n## For Heavy.Oil(138), We use the sum of B.A, B.B, B.C\n## For Misc. petroleum.refinery products(141), we use the sum of PetoCoke and OtherProd\n## For Fire.power.generation, we use Elect*((Total Demand of Fire Power generation(299)|IO_whole/(Total Demand of Fire Power Generation(299) +Total Demand of Other generation(301)]\n## For Other.generation, we use Elect*((Total Demand of Other generation(299)|IO_whole/(Total Demand of Fire Power Generation(299) +Total Demand of Other generation(301)]\n## (Since we don't have Other generation in EB, and we don't have Renewable in IO, \n##  we assume that Electricity demand excluding hydro and nuclear is the sum of Fire generataion and Other generation)\n\n### pick indexes of related items saved in E.Demand_total (30~33,131~141,298~303)\n\nindex1.c=c(\"Anthra_E\",\"Bit_E\")#Anthracite(30)/Bituminous.coal(31)\nindex1=match(index1.c,colnames(E.Demand_total))\n\nindex2.c=c(\"Naphta\",\"Gasoline\",\"JA.1\",\"Kerosene\",\"Diesel\") #Naphta(133)/Gasoline(134)/Jet.Oil(135)/Kerosene(136)/Light.oil(137)\nindex2=match(index2.c,colnames(E.Demand_total))\n  \nindex3.c=c(\"B.A\",\"B.B\",\"B.C\")#B.A+B.B+B.C = Heavy.Oil (138)\nindex3=match(index3.c,colnames(E.Demand_total))\n\nindex4.c=c(\"LPG_E\",\"Lubricant\") #Liqufied.petroleum.gas(139)/Lubricants(140)\nindex4=match(index4.c,colnames(E.Demand_total))\n\nindex5.c=c(\"PetroCoke\",\"OtherProd\")#PetroCoke+OtherProd = Misc.petroleum.refinery. products(141)\nindex5=match(index5.c,colnames(E.Demand_total))\n\nindex6.c=c(\"TownGas\",\"Heat\") #Manufactured.gas.supply(302)/Steam.and.hot.water.supply(303)\nindex6=match(index6.c,colnames(E.Demand_total))\n\nindex_IO=c(30:33,131:141,298:303)\n\n### calculate share of Fire/Other generation to split E.Demand_total$Elect\nElect.Fire=IO_whole[299,\"Total.demand\"]/(IO_whole[299,\"Total.demand\"]+IO_whole[301,\"Total.demand\"])\nElect.Other=IO_whole[301,\"Total.demand\"]/(IO_whole[299,\"Total.demand\"]+IO_whole[301,\"Total.demand\"])\n\n### Construdt E.Demand_IO\nE.Demand_IO=c(E.Demand_total[index1],E.Demand_Crude,E.Demand_total$LNG,E.Demand_Coalbriquette,E.Demand.Other_c,E.Demand_total[index2],sum(E.Demand_total[index3]),E.Demand_total[index4],sum(E.Demand_total[index5]),E.Demand_total$Hydro,(E.Demand_total$Elect*Elect.Fire),E.Demand_total$Nuclear,(E.Demand_total$Elect*Elect.Other),E.Demand_total[index6]) \nE.Demand_IO=data.frame(E.Demand_IO)\n\n### Provide col names\nIO_name=colnames(IO_whole)\ncolnames(E.Demand_IO)=IO_name[index_IO]\n\n### Save as k*1 matrix\nE.Demand_IO.m=as.matrix((as.numeric(E.Demand_IO)),nrow=length(E.Demand_IO))\nrownames(E.Demand_IO.m)=IO_name[index_IO]\ncolnames(E.Demand_IO.m)=c(\"Total.demand\")\n\n\n# step 3:  Allocated intermediate demand/final demand of Total E generated by each type of fuel/Electricity generation                                                                                                    \n## In this step, we redistribute \"Total.demand\" according to I-O intermediate demand /final demand. \n## [Residuals]For five fuels, we put some important components of E demand into specified I-O cells, and redistribute the residual\n##  acoording to the rest of I-O. These Five Fuels are Anthracite, Bituminous.coal, Naphta, Heavy.oil, Towngas. \n## [Overalls] For the rest, we redistribute \"Total.Demand\" itself according to I-O\n\n## step 3-1: Obtain relevent data,  add row names and numbers\nEnergy_IO=IO_whole[index_IO,]\nEnergy_IO=cbind(data.frame(index_IO),Energy_IO)\nrownames(Energy_IO)=rownames(E.Demand_IO.m)\n## step 3-2: Separate Residual and Overall\nindex_residual=c(\"Anthracite\", \"Bituminous.coal\",\"Naphtha\",\"Heavy.oil\",\"Manufactured.gas.supply\")\nindex.residual.m=match(index_residual,rownames(Energy_IO))\n#index.residual.m=c(1,2,7,12,20)\n\nEnergy_IO_residual=Energy_IO[index_residual,]\nIndex_IO_residual=Energy_IO_residual$index_IO\nEnergy_IO_overall=Energy_IO[-index.residual.m,]\nIndex_IO_overall=Energy_IO_overall$index_IO\n\nE.Demand_IO.residual=E.Demand_IO.m[index.residual.m,]\nE.Demand_IO.overall=E.Demand_IO.m[-index.residual.m,]\n\n## step 3-3. overall. \n### (i) select \"Total.supply\" column from Energy_IO_residual (TS_IO_overall)\nTS_IO_overall=Energy_IO_overall[,\"Total.supply\"]\n###  (ii) devide E.Demand_IO_overall by \"Total. supply\" (optain E.demand per moneytary unit. E.Demand_overall_money)\nE.Demand_IO.overall_money=E.Demand_IO.overall/TS_IO_overall\n###   (iii) multiply Energy_IO_overall with E.demand per monetary unit\nEnergy_BE_overall=Energy_IO_overall*E.Demand_IO.overall_money\n####   (iv) obtain sum of intermediate demand and sum of final demand. check matching\nEnergy_BE_overall[,\"Total.intermediate.demand\"]=rowSums(Energy_BE_overall[,2:404])\nEnergy_BE_overall[,\"Total.final.demand\"]=rowSums(Energy_BE_overall[,406:411])\n\n## step 3-4 residual.\n### (i) prepare monetary residual\n#### a. identify designated cells for 'residual members'\nindex.anth=c(\"Coal.briquettes\",\"Fire.power.generation\")\nindex.bit=\"Fire.power.generation\"\nindex.Naphtha=143:172\nindex.heavyoil=\"Fire.power.generation\"\nindex.towngas=c(\"Fire.power.generation\",\"Steam.and.hot.water.supply\")\n#### b. take out the money for designated cells from total money spent \nmoney.out=c(sum(Energy_IO_residual[\"Anthracite\",index.anth]),Energy_IO_residual[\"Bituminous.coal\",index.bit],sum(Energy_IO_residual[\"Naphtha\",index.Naphtha]),Energy_IO_residual[\"Heavy.oil\", index.heavyoil], sum(Energy_IO_residual[\"Manufactured.gas.supply\",index.towngas]))\nTS_IO_residual=Energy_IO_residual[,\"Total.supply\"]-money.out\n#### c.indentify energy for designated cells\nanth.desig.bit=EB_N_total[\"Residential\",\"Anthra_N\"]\nanth.desig.E_Gene=-1*min(c(EB_N_total[\"E_Gene\",\"Anthra_N\"],0))\nanth.desig=c(anth.desig.bit,anth.desig.E_Gene)\nbit.desig=-1*min(c(EB_N_total[\"E_Gene\",\"Bit_N\"],0))\nNaphtha.desig=EB_N_total[\"PetChem\",\"Naphta\"]\nHeavoil.desig=-1*min(c(EB_N_total[\"E_Gene\",\"B.A\"],0))-1*min(c(EB_N_total[\"E_Gene\",\"B.B\"],0))-1*min(c(EB_N_total[\"E_Gene\",\"B.C\"],0))\nTowngas.desig.E_Gene=-1*min(c(EB_N_total[\"E_Gene\",\"LNG\"],0))-1*min(c(EB_N_total[\"E_Gene\",\"TownGas\"],0))\nTowngas.desig.Heating=-1*min(c(EB_N_total[\"Heating\",\"LNG\"],0))-1*min(c(EB_N_total[\"Heating\",\"TownGas\"],0))\nTowngas.desig=c(Towngas.desig.E_Gene,Towngas.desig.Heating)\n#### d.take designated energy from Total E. Demand \nE.Demand_IO.residual_d=c(sum(anth.desig),bit.desig,Naphtha.desig,Heavoil.desig,sum(Towngas.desig))\nE.Demand_IO.residual_r=E.Demand_IO.residual-E.Demand_IO.residual_d\n### (ii) devide E.Demand_IO_residual_r by TS_IO_residual (obtain E. demand per monetary unit for residual. E.Demand_residual_money)\nE.Demand_IO.residual_money=E.Demand_IO.residual_r/TS_IO_residual\n### (iii) multiply Energy_IO_residual wit E.Demand_IO.residual_money (distribute residual energy)\nEnergy_BE_residual=Energy_IO_residual*E.Demand_IO.residual_money\n### (iv) Replace designated cell with designated Energy demand\nEnergy_BE_residual[\"Anthracite\",index.anth]=anth.desig\nEnergy_BE_residual[\"Bituminous.coal\",index.bit]=bit.desig\nEnergy_BE_residual[\"Heavy.oil\", index.heavyoil]=Heavoil.desig\nEnergy_BE_residual[\"Manufactured.gas.supply\",index.towngas]=Towngas.desig\nEnergy_BE_residual[\"Naphtha\",index.Naphtha]=Naphtha.desig*(Energy_IO_residual[\"Naphtha\",index.Naphtha]/(sum(Energy_IO_residual[\"Naphtha\",index.Naphtha]))) \n### (v) Replace subsum columns with actual subsums\nEnergy_BE_residual[,\"Total.intermediate.demand\"]=rowSums(Energy_BE_residual[,2:404])\nEnergy_BE_residual[,\"Total.final.demand\"]=rowSums(Energy_BE_residual[,406:411])\nEnergy_BE_residual[,\"Total.demand\"]=Energy_BE_residual[,\"Total.intermediate.demand\"]+Energy_BE_residual[,\"Total.final.demand\"]\nEnergy_BE_residual[,\"Total.supply\"]=Energy_BE_residual[,\"Total.demand\"] \n\n## step 3-5  merge and Replace \"Gross.domestic.output.Basic price\", \"Import.Basic.price\" with \n###  Gross.domestic.output.Basic.price = sum of intermediate demand for domestic energy + sum of final demand for domestic energy\n###  * intermediate demand for domestic energy : 0 if intermediate demand in total IO is 0, \n###  otherwise intermediate demand for energy *(intermediate domesitc demand in domestic IO/intermediate domestic demand in total IO(Energy_IO))\n###  * final demand for domestic energy: 0 if final demand in total IO is 0,\n###  otherwise final demand for energy*(final demand in doemstic IO/final demand in total IO)\n\n#### (i) merge Engery_BE_residual and Energy_BE_overall\n##### a. put back indexes\nEnergy_BE_overall$index_IO=Index_IO_overall        \nEnergy_BE_residual$index_IO=Index_IO_residual\n##### b.merge and sort\nEnergy_BE=rbind(Energy_BE_overall,Energy_BE_residual)\nEnergy_BE=Energy_BE[order(Energy_BE$index_IO),]\n\n##### (ii). calculate intermediate demand_dometic/intermeidate demand_whole\n###### a. Obtain Energy_IO_domestic\nEnergy_IO_Domestic=IO_Domestic[index_IO,]\nEnergy_IO_Domestic=cbind(data.frame(index_IO),Energy_IO_Domestic)\nrownames(Energy_IO_Domestic)=rownames(E.Demand_IO.m)\n###### b.  Obtain Domestic/Whole share\nEnergy_IO.m=as.matrix(Energy_IO)\nEnergy_IO_Domestic.m=as.matrix(Energy_IO_Domestic)\nEnergy_IO_Domestic_share=Energy_IO.m\nEnergy_IO_Domestic_share=ifelse(Energy_IO.m==0,0,(Energy_IO_Domestic.m/Energy_IO.m)) # set Energy_IO_Domestic_share as zero if Energy_IO is zero\nEnergy_IO_Domestic_share=data.frame(Energy_IO_Domestic_share)\n\n#### (iii) Obtain E demand for domestic production/Imports\n\n###### a. Multiply Energy demand with (Domestic/Total) factor\nEnergy_BE_Domestic=Energy_BE*Energy_IO_Domestic_share\n###### b.  Obtain subsums\nEnergy_BE_Domestic$Total.intermediate.demand=rowSums(Energy_BE_Domestic[,2:404])\nEnergy_BE_Domestic$Total.final.demand=rowSums(Energy_BE_Domestic[,406:411])\n\nEnergy_BE_Domestic$Total.demand=Energy_BE_Domestic$Total.intermediate.demand+Energy_BE_Domestic$Total.final.demand\n##### c. Replace GDP and Imports in Energy_BE with calculated subsums\nEnergy_BE$Gross.domestic.output.Basic.price.=Energy_BE_Domestic$Total.demand\nEnergy_BE$Imports..Basic.price.=Energy_BE$Total.demand-Energy_BE$Gross.domestic.output.Basic.price.\n                                                                 \n# step 4: Convert intermediate demand of E/final demand of E/ E demand assigned to domestic production(import) into CO2 emission\n## In this step, we multiply Energy demand with emission factor (unit =toe)\n## For Naphtha and Lubricant, some of carbon contained in these materials would sink to the final output. The rest would be released.\n## For generation (Electricity, Heat), carbon is released in the generation process only. \n## What is emitted after generation is assumed as the hidden emission in generation. Using electricity or heat wouldn't emit additional GHG.\n## So, we set zero emisson factor for (power.generation, Steam.and.hot.water.supply)\n## After multiplication, we set zero from emission in inrease.in.stock/Exports. Those are not emitted within our territory.\n## Finally, adjuste Total.intermediate.demand/Total.final.demand/Total.demand. These subsomes should be recalculated.\n\n## Step 4-1. prepare emission factor \n\n### (ii) convert carbon emission factor(ton/toe) to CO2 emission factor\nEC$CO2.emission=(44/12)*EC$C.emission\n### (iii)adjust for sinking in Naphtha and Lubricants\nEC$EF=(1-EC$Sinking)*EC$CO2.emission\n\n##Step 4-2. Obtaion emission factor*Energy\n### Multiply Energy demand with emission factor\nECO2=Energy_BE*EC$EF\n### setting increase.in.stock/Exports. as zero\nECO2$Increase.in.stocks=0\nECO2$Exports=0\n### Adjusting subsums and obtain totals.\nECO2$Total.intermediate.demand=rowSums(ECO2[,2:404])\nECO2$Total.final.demand=rowSums(ECO2[,406:411])\nECO2$Total.demand=ECO2$Total.intermediate.demand+ECO2$Total.final.demand\n\n## Step 4-3. Excluding double counting\n### indexing double counting cells.\nindex.Anth.Exc=132:133 # Coal.briquettes and Coke.and.other.coal.products  (CO2 is emitted when 2nd products are used)\nindex.Bit.Exc=132:133  # Coal.briquettes and Coke.and.other.coal.products  (CO2 is emitted when 2nd products are used)\nindex.Crude.Exc=134:142 # Petro products  (CO2 is emitted when 2nd products are used)\nindex.Ngas.Exc=303 #Manufactured.gas.supply (CO2 is emitted when Manufactured gas is used)\nindex.LPG.Exc=303  #Manufactured.gas.supply (CO2 is emitted when Manufactured gas is used)\n\n### setting indexed cells as zero\nECO2[\"Anthracite\",index.Anth.Exc]=0                        \nECO2[\"Bituminous.coal\",index.Bit.Exc]=0                  \nECO2[\"Crude.petroleum\",index.Crude.Exc]=0                   \nECO2[\"Natural.gas\",index.Ngas.Exc]=0                      \nECO2[\"Liquefied.petroleum.gas\",index.LPG.Exc]=0    \n\n### Adjusting subsums and obtain totals.\nECO2$Total.intermediate.demand=rowSums(ECO2[,2:404])\nECO2$Total.final.demand=rowSums(ECO2[,406:411])\nECO2$Total.demand=ECO2$Total.intermediate.demand+ECO2$Total.final.demand\n\n## Step 4-4. Obtain CO2 emission by industry\nECO2.slim=cbind(Energy_BE$index_IO,ECO2[,2:413]) # cut off final demand section after Total.demand/shed industry index\nECO2.ind=colSums(ECO2.slim[-1])\nECO2.ind.5dg=as.numeric(formatC(ECO2.ind,format=\"f\",digits=5))\nnames(ECO2.ind.5dg)=names(ECO2.ind)\nECO2.slim=rbind(ECO2.slim,c(0,ECO2.ind.5dg))\nECO2.result=list(ECO2.slim,ECO2.ind.5dg) \nreturn(ECO2.result)\n} \n\n# step 5: add CO2 in process                                   ",
    "created" : 1429234764379.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2403072837",
    "id" : "3E31B7D5",
    "lastKnownWriteTime" : 1429238890,
    "path" : "D:/ghg/ghg_function1.r",
    "project_path" : "ghg_function1.r",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}